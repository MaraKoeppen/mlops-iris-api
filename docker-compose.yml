services:

  # Service 1: FastAPI application with the Iris ML model
  mlops-iris-api:

    # Build the Docker image for this service
    build:

      # Root directory of the project (build context)
      context: .

      # Path to the Dockerfile that defines the FastAPI container
      dockerfile: src/api/Dockerfile 

    # Expose port 8000 ONLY to other containers inside the Docker network
    # This makes the API accessible to nginx, but not directly to the host machine
    expose:
      - "8000"


  # Service 2: NGINX reverse proxy
  nginx:

    # Build the nginx image from its Dockerfile
    build:

      # Folder containing nginx Dockerfile and configuration
      context: deployments/nginx/

      # Dockerfile used to build the nginx container
      dockerfile: Dockerfile


    # Assign a fixed name to the nginx container (easier to identify)
    container_name: nginx_revproxy


    # Map host ports to container ports
    ports:

      # Map host port 8080 → container port 80 (HTTP)
      - "8080:80"

      # Map host port 443 → container port 443 (HTTPS)
      - "443:443"


    # Mount configuration files and security files into the container
    volumes:

      # Mount nginx configuration file
      # :ro means read-only for security (container cannot modify it)
      - ./deployments/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # Mount SSL certificates directory for HTTPS
      - ./deployments/nginx/certs:/etc/nginx/certs:ro

      # Mount password file for basic authentication
      - ./deployments/nginx/.htpasswd:/etc/nginx/.htpasswd:ro


    # Ensure the API container starts before nginx
    # nginx depends on the API to forward re
